apiVersion: v1
kind: Secret
metadata:
  name: emr-secrets
  namespace: default
  labels:
    app: emr-service
    security-tier: restricted
    compliance: hipaa
    data-classification: phi
  annotations:
    # HashiCorp Vault Integration
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "emr-service"
    vault.hashicorp.com/secret-rotation: "true"
    vault.hashicorp.com/secret-rotation-period: "90d"
    vault.hashicorp.com/secret-volume-path: "/vault/secrets"
    # Audit and Security
    audit.k8s.io/policy: "audit-all-access"
    security.cloud.google.com/kms-key: "projects/healthcare-prod/locations/global/keyRings/emr-keys/cryptoKeys/emr-secret-key"
type: Opaque
# SECURITY FIX: Secrets injected via External Secrets Operator
# All sensitive values are retrieved from HashiCorp Vault or AWS Secrets Manager at runtime
# DO NOT hardcode secret values in this file
stringData:
  # Epic EMR Integration Credentials
  # Values injected from Vault path: secret/data/emr/epic
  epic.base_url: "https://fhir.epic.com/api/fhir/r4"
  # epic.client_id will be injected via Vault annotation
  # epic.client_secret will be injected via Vault annotation
  # epic.api_key will be injected via Vault annotation
  epic.auth_url: "https://auth.epic.com/oauth2/token"
  epic.timeout: "30"
  epic.retry_config: '{"max_retries": 3, "backoff_multiplier": 2}'
  epic.version: "R4"

  # Cerner EMR Integration Credentials
  # Values injected from Vault path: secret/data/emr/cerner
  cerner.base_url: "https://fhir.cerner.com/dcweb/api/v4"
  # cerner.client_id will be injected via Vault annotation
  # cerner.client_secret will be injected via Vault annotation
  # cerner.api_key will be injected via Vault annotation
  cerner.auth_url: "https://auth.cerner.com/tenants/oauth2/token"
  cerner.timeout: "30"
  cerner.retry_config: '{"max_retries": 3, "backoff_multiplier": 2}'
  cerner.version: "R4"

---
# External Secrets Operator - Epic Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: epic-credentials
  namespace: default
  labels:
    app: emr-service
    component: epic-integration
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: emr-secrets
    creationPolicy: Merge
  data:
    - secretKey: epic.client_id
      remoteRef:
        key: secret/data/emr/epic
        property: client_id
    - secretKey: epic.client_secret
      remoteRef:
        key: secret/data/emr/epic
        property: client_secret
    - secretKey: epic.api_key
      remoteRef:
        key: secret/data/emr/epic
        property: api_key
    - secretKey: epic.tls_cert
      remoteRef:
        key: secret/data/emr/epic
        property: tls_cert

---
# External Secrets Operator - Cerner Credentials
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: cerner-credentials
  namespace: default
  labels:
    app: emr-service
    component: cerner-integration
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: emr-secrets
    creationPolicy: Merge
  data:
    - secretKey: cerner.client_id
      remoteRef:
        key: secret/data/emr/cerner
        property: client_id
    - secretKey: cerner.client_secret
      remoteRef:
        key: secret/data/emr/cerner
        property: client_secret
    - secretKey: cerner.api_key
      remoteRef:
        key: secret/data/emr/cerner
        property: api_key
    - secretKey: cerner.tls_cert
      remoteRef:
        key: secret/data/emr/cerner
        property: tls_cert

---
# SecretStore - HashiCorp Vault Backend
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: default
spec:
  provider:
    vault:
      server: "http://vault.vault-system.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "emr-service"
          serviceAccountRef:
            name: "emr-service"