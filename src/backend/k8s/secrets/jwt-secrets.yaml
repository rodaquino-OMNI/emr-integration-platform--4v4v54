apiVersion: v1
kind: Secret
metadata:
  name: jwt-secrets
  namespace: emr-task
  labels:
    app: api-gateway
    component: security
    environment: production
  annotations:
    # Secret rotation policy - 90 days
    kubernetes.io/rotation-period: "2160h"
    
    # Vault agent injector configuration
    vault.hashicorp.com/agent-inject: "true"
    vault.hashicorp.com/role: "api-gateway"
    vault.hashicorp.com/agent-inject-secret-jwt: "auth/jwt/keys"
    vault.hashicorp.com/agent-pre-populate: "true"
    
    # Cloud KMS encryption configuration
    security.cloud.google.com/kms-key: "projects/emr-task/locations/global/keyRings/app-secrets/cryptoKeys/jwt-key"

type: Opaque
# SECURITY FIX: Secrets injected via External Secrets Operator
# Sensitive JWT signing keys are retrieved from Vault at runtime
stringData:
  # Non-sensitive configuration values
  JWT_EXPIRY: "3600"  # 1 hour
  REFRESH_TOKEN_EXPIRY: "2592000"  # 30 days
  JWT_ALGORITHM: "HS512"
  JWT_ISSUER: "emr-task-platform"
  JWT_AUDIENCE: "emr-task-api"

---
# External Secrets Operator - JWT Signing Keys
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: jwt-signing-keys
  namespace: emr-task
  labels:
    app: api-gateway
    component: security
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: SecretStore
  target:
    name: jwt-secrets
    creationPolicy: Merge
  data:
    - secretKey: JWT_SECRET
      remoteRef:
        key: secret/data/auth/jwt
        property: secret
    - secretKey: JWT_REFRESH_SECRET
      remoteRef:
        key: secret/data/auth/jwt
        property: refresh_secret

---
# SecretStore for API Gateway
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: vault-backend
  namespace: emr-task
spec:
  provider:
    vault:
      server: "http://vault.vault-system.svc.cluster.local:8200"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "api-gateway"
          serviceAccountRef:
            name: "api-gateway"

---
# RBAC configuration for secret access
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: jwt-secrets-reader
  namespace: emr-task
rules:
- apiGroups: [""]
  resources: ["secrets"]
  resourceNames: ["jwt-secrets"]
  verbs: ["get"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: jwt-secrets-reader-binding
  namespace: emr-task
subjects:
- kind: ServiceAccount
  name: api-gateway
  namespace: emr-task
roleRef:
  kind: Role
  name: jwt-secrets-reader
  apiGroup: rbac.authorization.k8s.io