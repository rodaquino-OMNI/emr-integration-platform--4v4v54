// Prisma Schema for Handover Service
// EMR Integration Platform - Phase 2 Remediation
//
// This schema defines the handover domain models
// and their relationships for the handover microservice.
//
// Database: PostgreSQL 14+
// ORM: Prisma 5.x
// Generated Client: @prisma/client

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto]
}

// Enums
enum UserRole {
  NURSE
  DOCTOR
  ADMIN
  SUPERVISOR

  @@map("user_role")
}

enum TaskStatus {
  TO_DO
  IN_PROGRESS
  COMPLETED
  BLOCKED
  PENDING_VERIFICATION

  @@map("task_status")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("task_priority")
}

// User model (subset for handover service)
model User {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  username        String    @unique @db.VarChar(255)
  email           String    @unique @db.VarChar(255)
  role            UserRole
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  supervisedShifts    Shift[]     @relation("ShiftSupervisor")
  initiatedHandovers  Handover[]  @relation("HandoverInitiator")
  acceptedHandovers   Handover[]  @relation("HandoverAcceptor")

  @@map("users")
}

// Department model
model Department {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String    @db.VarChar(255)
  code        String    @unique @db.VarChar(50)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  shifts      Shift[]

  @@map("departments")
}

// Shift model
model Shift {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  departmentId  String    @map("department_id") @db.Uuid
  startTime     DateTime  @map("start_time") @db.Timestamptz(6)
  endTime       DateTime  @map("end_time") @db.Timestamptz(6)
  supervisorId  String    @map("supervisor_id") @db.Uuid
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  department          Department   @relation(fields: [departmentId], references: [id])
  supervisor          User         @relation("ShiftSupervisor", fields: [supervisorId], references: [id])
  outgoingHandovers   Handover[]   @relation("HandoverFromShift")
  incomingHandovers   Handover[]   @relation("HandoverToShift")

  @@index([departmentId])
  @@index([supervisorId])
  @@index([startTime, endTime])
  @@map("shifts")
}

// Handover model (core entity for this service)
model Handover {
  id                    String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromShiftId           String              @map("from_shift_id") @db.Uuid
  toShiftId             String              @map("to_shift_id") @db.Uuid
  initiatedById         String              @map("initiated_by") @db.Uuid
  acceptedById          String?             @map("accepted_by") @db.Uuid
  taskSummary           Json                @map("task_summary") @db.JsonB
  criticalEvents        Json                @map("critical_events") @db.JsonB
  isCompleted           Boolean             @default(false) @map("is_completed")
  completedAt           DateTime?           @map("completed_at") @db.Timestamptz(6)
  vectorClockNodeId     String              @map("vector_clock_node_id") @db.VarChar(50)
  vectorClockCounter    BigInt              @default(0) @map("vector_clock_counter")
  vectorClockTimestamp  BigInt              @map("vector_clock_timestamp")
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  fromShift     Shift           @relation("HandoverFromShift", fields: [fromShiftId], references: [id])
  toShift       Shift           @relation("HandoverToShift", fields: [toShiftId], references: [id])
  initiatedBy   User            @relation("HandoverInitiator", fields: [initiatedById], references: [id])
  acceptedBy    User?           @relation("HandoverAcceptor", fields: [acceptedById], references: [id])
  items         HandoverItem[]

  @@index([fromShiftId])
  @@index([toShiftId])
  @@index([initiatedById])
  @@index([isCompleted])
  @@index([vectorClockNodeId, vectorClockCounter, vectorClockTimestamp], name: "idx_handovers_vector_clock")
  @@index([createdAt])
  @@map("handovers")
}

// Handover Item model (detailed handover entries)
model HandoverItem {
  id              String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  handoverId      String        @map("handover_id") @db.Uuid
  taskId          String?       @map("task_id") @db.Uuid
  patientMrn      String        @map("patient_mrn") @db.VarChar(50)
  patientName     String        @map("patient_name") @db.VarChar(255)
  priority        TaskPriority
  status          TaskStatus
  description     String        @db.Text
  notes           String?       @db.Text
  actionRequired  Boolean       @default(false) @map("action_required")
  isAcknowledged  Boolean       @default(false) @map("is_acknowledged")
  acknowledgedAt  DateTime?     @map("acknowledged_at") @db.Timestamptz(6)
  metadata        Json          @default("{}") @db.JsonB
  sortOrder       Int           @default(0) @map("sort_order")
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime      @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  handover        Handover      @relation(fields: [handoverId], references: [id], onDelete: Cascade)

  @@index([handoverId])
  @@index([taskId])
  @@index([patientMrn])
  @@index([priority, status])
  @@index([actionRequired])
  @@map("handover_items")
}

// Handover Template model (for standardized handovers)
model HandoverTemplate {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  departmentId    String?   @map("department_id") @db.Uuid
  templateData    Json      @map("template_data") @db.JsonB
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([departmentId])
  @@index([isActive])
  @@map("handover_templates")
}

// Handover Audit Log model
model HandoverAuditLog {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  handoverId      String    @map("handover_id") @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  action          String    @db.VarChar(100)
  changes         Json      @db.JsonB
  ipAddress       String    @map("ip_address") @db.VarChar(45)
  userAgent       String?   @map("user_agent") @db.Text
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([handoverId])
  @@index([userId])
  @@index([createdAt])
  @@map("handover_audit_logs")
}
