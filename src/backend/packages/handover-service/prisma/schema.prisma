// Prisma schema for Handover Service
// Generator configuration for Prisma Client v4.16.2

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
  binaryTargets = ["native", "debian-openssl-1.1.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums matching database types
enum UserRole {
  NURSE
  DOCTOR
  ADMIN
  SUPERVISOR
}

enum TaskStatus {
  TO_DO
  IN_PROGRESS
  COMPLETED
  BLOCKED
  PENDING_VERIFICATION
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum EmrSystem {
  EPIC
  CERNER
  GENERIC_FHIR
}

// Users table
model User {
  id                  String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  username            String     @unique
  email               String     @unique
  role                UserRole
  passwordHash        String     @map("password_hash")
  mfaSecret           String?    @map("mfa_secret")
  isActive            Boolean    @default(true) @map("is_active")
  lastLogin           DateTime?  @map("last_login") @db.Timestamptz
  preferences         Json       @default("{}")
  createdAt           DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt           DateTime   @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt           DateTime?  @map("deleted_at") @db.Timestamptz

  // Relations
  supervisedShifts    Shift[]    @relation("SupervisedShifts")
  initiatedHandovers  Handover[] @relation("InitiatedHandovers")
  acceptedHandovers   Handover[] @relation("AcceptedHandovers")

  @@map("users")
}

// Departments table
model Department {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String
  code        String   @unique
  description String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  shifts      Shift[]

  @@map("departments")
}

// Shifts table
model Shift {
  id                String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  departmentId      String     @map("department_id") @db.Uuid
  startTime         DateTime   @map("start_time") @db.Timestamptz
  endTime           DateTime   @map("end_time") @db.Timestamptz
  supervisorId      String     @map("supervisor_id") @db.Uuid
  isActive          Boolean    @default(true) @map("is_active")
  createdAt         DateTime   @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime   @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  department        Department @relation(fields: [departmentId], references: [id])
  supervisor        User       @relation("SupervisedShifts", fields: [supervisorId], references: [id])
  handoversFrom     Handover[] @relation("HandoversFrom")
  handoversTo       Handover[] @relation("HandoversTo")

  @@map("shifts")
}

// Handovers table
model Handover {
  id                   String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromShiftId          String   @map("from_shift_id") @db.Uuid
  toShiftId            String   @map("to_shift_id") @db.Uuid
  initiatedBy          String   @map("initiated_by") @db.Uuid
  acceptedBy           String?  @map("accepted_by") @db.Uuid
  taskSummary          Json     @map("task_summary")
  criticalEvents       Json     @map("critical_events")
  isCompleted          Boolean  @default(false) @map("is_completed")
  completedAt          DateTime? @map("completed_at") @db.Timestamptz
  vectorClockNodeId    String   @map("vector_clock_node_id") @db.VarChar(50)
  vectorClockCounter   BigInt   @default(0) @map("vector_clock_counter")
  vectorClockTimestamp BigInt   @map("vector_clock_timestamp")
  createdAt            DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime @updatedAt @map("updated_at") @db.Timestamptz

  // Relations
  fromShift            Shift    @relation("HandoversFrom", fields: [fromShiftId], references: [id])
  toShift              Shift    @relation("HandoversTo", fields: [toShiftId], references: [id])
  initiator            User     @relation("InitiatedHandovers", fields: [initiatedBy], references: [id])
  acceptor             User?    @relation("AcceptedHandovers", fields: [acceptedBy], references: [id])

  @@index([fromShiftId], name: "idx_handovers_from_shift")
  @@index([toShiftId], name: "idx_handovers_to_shift")
  @@index([isCompleted], name: "idx_handovers_completed")
  @@index([vectorClockNodeId, vectorClockCounter, vectorClockTimestamp], name: "idx_handovers_vector_clock")
  @@index([vectorClockTimestamp], name: "idx_handovers_vector_timestamp")
  @@map("handovers")
}

// Tasks table (read-only for querying in handover context)
model Task {
  id                   String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title                String
  description          String?
  status               TaskStatus   @default(TO_DO)
  priority             TaskPriority @default(MEDIUM)
  assignedTo           String?      @map("assigned_to") @db.Uuid
  createdBy            String       @map("created_by") @db.Uuid
  departmentId         String       @map("department_id") @db.Uuid
  shiftId              String?      @map("shift_id") @db.Uuid
  dueDate              DateTime?    @map("due_date") @db.Timestamptz
  emrSystem            EmrSystem    @map("emr_system")
  patientId            String       @map("patient_id") @db.Uuid
  emrData              Json         @map("emr_data")
  vectorClock          BigInt       @map("vector_clock")
  vectorClockNodeId    String       @map("vector_clock_node_id") @db.VarChar(50)
  vectorClockCounter   BigInt       @default(0) @map("vector_clock_counter")
  vectorClockTimestamp BigInt       @map("vector_clock_timestamp")
  version              Int          @default(1)
  requiresVerification Boolean      @default(false) @map("requires_verification")
  createdAt            DateTime     @default(now()) @map("created_at") @db.Timestamptz
  updatedAt            DateTime     @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt            DateTime?    @map("deleted_at") @db.Timestamptz

  @@index([shiftId, status], name: "idx_tasks_shift_status")
  @@index([departmentId, status], name: "idx_tasks_dept_status")
  @@map("tasks")
}

// Patients table (read-only for querying in handover context)
model Patient {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  mrn           String    @unique @db.VarChar(50)
  firstName     String    @map("first_name") @db.VarChar(100)
  lastName      String    @map("last_name") @db.VarChar(100)
  dateOfBirth   DateTime  @map("date_of_birth") @db.Date
  emrSystem     EmrSystem @map("emr_system")
  emrId         String    @map("emr_id") @db.VarChar(100)
  encryptedData Json      @default("{}") @map("encrypted_data")
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz
  deletedAt     DateTime? @map("deleted_at") @db.Timestamptz

  @@unique([emrSystem, emrId], name: "idx_patients_emr_unique")
  @@map("patients")
}

// Audit Logs table (read-only for querying)
model AuditLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  action          String
  entityType      String   @map("entity_type")
  entityId        String   @map("entity_id") @db.Uuid
  userId          String   @map("user_id") @db.Uuid
  changes         Json
  createdAt       DateTime @map("created_at") @db.Timestamptz
  ipAddress       String?  @map("ip_address")
  userAgent       String?  @map("user_agent")
  sessionId       String?  @map("session_id") @db.Uuid
  emrSystem       String?  @map("emr_system")
  emrPatientId    String?  @map("emr_patient_id")
  emrContext      Json?    @map("emr_context")
  requestId       String   @map("request_id") @db.Uuid
  metadata        Json?

  @@index([entityType, entityId], name: "idx_audit_logs_entity")
  @@index([createdAt], name: "idx_audit_logs_created_at_brin")
  @@map("audit_logs")
}
