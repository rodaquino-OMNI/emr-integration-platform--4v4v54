// Prisma Schema for Task Service
// EMR Integration Platform - Phase 2 Remediation
//
// This schema defines the task management domain models
// and their relationships for the task microservice.
//
// Database: PostgreSQL 14+
// ORM: Prisma 5.x
// Generated Client: @prisma/client

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma-client"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [uuid_ossp(map: "uuid-ossp"), pgcrypto]
}

// Enums matching database types
enum TaskStatus {
  TO_DO
  IN_PROGRESS
  COMPLETED
  BLOCKED
  PENDING_VERIFICATION

  @@map("task_status")
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL

  @@map("task_priority")
}

enum UserRole {
  NURSE
  DOCTOR
  ADMIN
  SUPERVISOR

  @@map("user_role")
}

enum EmrSystem {
  EPIC
  CERNER
  GENERIC_FHIR

  @@map("emr_system")
}

enum VerificationStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED

  @@map("verification_status")
}

// User model
model User {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  username        String    @unique @db.VarChar(255)
  email           String    @unique @db.VarChar(255)
  role            UserRole
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  mfaSecret       String?   @map("mfa_secret") @db.VarChar(255)
  isActive        Boolean   @default(true) @map("is_active")
  lastLogin       DateTime? @map("last_login") @db.Timestamptz(6)
  preferences     Json      @default("{}") @db.JsonB
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime? @map("deleted_at") @db.Timestamptz(6)

  // Relations
  assignedTasks        Task[]              @relation("TaskAssignee")
  createdTasks         Task[]              @relation("TaskCreator")
  supervisedShifts     Shift[]             @relation("ShiftSupervisor")
  verifications        EmrVerification[]
  initiatedHandovers   Handover[]          @relation("HandoverInitiator")
  acceptedHandovers    Handover[]          @relation("HandoverAcceptor")
  auditLogs            AuditLog[]

  @@map("users")
}

// Department model
model Department {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name        String    @db.VarChar(255)
  code        String    @unique @db.VarChar(50)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  shifts      Shift[]
  tasks       Task[]

  @@map("departments")
}

// Shift model
model Shift {
  id            String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  departmentId  String    @map("department_id") @db.Uuid
  startTime     DateTime  @map("start_time") @db.Timestamptz(6)
  endTime       DateTime  @map("end_time") @db.Timestamptz(6)
  supervisorId  String    @map("supervisor_id") @db.Uuid
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  department          Department   @relation(fields: [departmentId], references: [id])
  supervisor          User         @relation("ShiftSupervisor", fields: [supervisorId], references: [id])
  tasks               Task[]
  outgoingHandovers   Handover[]   @relation("HandoverFromShift")
  incomingHandovers   Handover[]   @relation("HandoverToShift")

  @@index([departmentId])
  @@index([supervisorId])
  @@index([startTime, endTime])
  @@map("shifts")
}

// Patient model
model Patient {
  id            String      @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  mrn           String      @unique @db.VarChar(50)
  firstName     String      @map("first_name") @db.VarChar(100)
  lastName      String      @map("last_name") @db.VarChar(100)
  dateOfBirth   DateTime    @map("date_of_birth") @db.Date
  gender        String?     @db.VarChar(20)
  emrSystem     EmrSystem   @map("emr_system")
  emrPatientId  String      @map("emr_patient_id") @db.VarChar(100)
  emrMetadata   Json        @default("{}") @map("emr_metadata") @db.JsonB
  phone         String?     @db.VarChar(20)
  email         String?     @db.VarChar(255)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime    @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt     DateTime?   @map("deleted_at") @db.Timestamptz(6)

  // Relations
  tasks         Task[]

  @@unique([emrSystem, emrPatientId], name: "uq_patients_emr_system_patient_id")
  @@index([mrn])
  @@index([emrSystem, emrPatientId])
  @@index([dateOfBirth])
  @@index([lastName, firstName])
  @@map("patients")
}

// Task model (core entity)
model Task {
  id                    String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  title                 String              @db.VarChar(255)
  description           String?             @db.Text
  status                TaskStatus          @default(TO_DO)
  priority              TaskPriority        @default(MEDIUM)
  assignedToId          String?             @map("assigned_to") @db.Uuid
  createdById           String              @map("created_by") @db.Uuid
  departmentId          String              @map("department_id") @db.Uuid
  shiftId               String?             @map("shift_id") @db.Uuid
  dueDate               DateTime?           @map("due_date") @db.Timestamptz(6)
  emrSystem             EmrSystem           @map("emr_system")
  patientId             String              @map("patient_id") @db.VarChar(255) // Legacy field
  patientUuid           String?             @map("patient_uuid") @db.Uuid
  emrData               Json                @map("emr_data") @db.JsonB
  vectorClock           BigInt              @map("vector_clock")
  vectorClockNodeId     String              @map("vector_clock_node_id") @db.VarChar(50)
  vectorClockCounter    BigInt              @default(0) @map("vector_clock_counter")
  vectorClockTimestamp  BigInt              @map("vector_clock_timestamp")
  version               Int                 @default(1)
  requiresVerification  Boolean             @default(false) @map("requires_verification")
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt             DateTime?           @map("deleted_at") @db.Timestamptz(6)

  // Relations
  assignedTo      User?               @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdBy       User                @relation("TaskCreator", fields: [createdById], references: [id])
  department      Department          @relation(fields: [departmentId], references: [id])
  shift           Shift?              @relation(fields: [shiftId], references: [id])
  patient         Patient?            @relation(fields: [patientUuid], references: [id])
  verifications   EmrVerification[]

  @@index([departmentId, status, dueDate])
  @@index([assignedToId, status])
  @@index([patientId, emrSystem])
  @@index([patientUuid])
  @@index([vectorClock])
  @@index([vectorClockNodeId, vectorClockCounter, vectorClockTimestamp], name: "idx_tasks_vector_clock")
  @@map("tasks")
}

// EMR Verification model
model EmrVerification {
  id                    String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  taskId                String              @map("task_id") @db.Uuid
  verifiedById          String              @map("verified_by") @db.Uuid
  status                VerificationStatus
  barcodeData           String?             @map("barcode_data") @db.VarChar(255)
  verificationMetadata  Json                @map("verification_metadata") @db.JsonB
  failureReason         String?             @map("failure_reason") @db.Text
  verifiedAt            DateTime            @map("verified_at") @db.Timestamptz(6)
  createdAt             DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt             DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  task          Task    @relation(fields: [taskId], references: [id])
  verifiedBy    User    @relation(fields: [verifiedById], references: [id])

  @@index([taskId])
  @@index([verifiedById])
  @@index([status])
  @@map("emr_verifications")
}

// Handover model
model Handover {
  id              String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  fromShiftId     String    @map("from_shift_id") @db.Uuid
  toShiftId       String    @map("to_shift_id") @db.Uuid
  initiatedById   String    @map("initiated_by") @db.Uuid
  acceptedById    String?   @map("accepted_by") @db.Uuid
  taskSummary     Json      @map("task_summary") @db.JsonB
  criticalEvents  Json      @map("critical_events") @db.JsonB
  isCompleted     Boolean   @default(false) @map("is_completed")
  completedAt     DateTime? @map("completed_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  fromShift     Shift   @relation("HandoverFromShift", fields: [fromShiftId], references: [id])
  toShift       Shift   @relation("HandoverToShift", fields: [toShiftId], references: [id])
  initiatedBy   User    @relation("HandoverInitiator", fields: [initiatedById], references: [id])
  acceptedBy    User?   @relation("HandoverAcceptor", fields: [acceptedById], references: [id])

  @@index([fromShiftId])
  @@index([toShiftId])
  @@index([isCompleted])
  @@map("handovers")
}

// Audit Log model (for compliance)
model AuditLog {
  id          String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  action      String    @db.VarChar(100)
  entityType  String    @map("entity_type") @db.VarChar(100)
  entityId    String    @map("entity_id") @db.Uuid
  changes     Json      @db.JsonB
  ipAddress   String    @map("ip_address") @db.VarChar(45)
  userAgent   String?   @map("user_agent") @db.Text
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user        User      @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt])
  @@index([userId])
  @@map("audit_logs")
}
