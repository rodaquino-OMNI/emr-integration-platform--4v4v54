name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  packages: write
  id-token: write
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TEST_COVERAGE_THRESHOLD: 85
  VULNERABILITY_THRESHOLD: high
  DOCKER_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        node-version: ['18.x', '20.x', '22.x']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            **/node_modules
            ~/.npm
            ~/.cache
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-
            ${{ runner.os }}-node-

      - name: Install dependencies
        run: npm ci
        working-directory: ./src/backend

      - name: Build packages
        run: npm run build
        working-directory: ./src/backend

      - name: Lint and format (parallel)
        run: |
          npm run lint &
          LINT_PID=$!
          npm run format -- --check &
          FORMAT_PID=$!
          wait $LINT_PID
          wait $FORMAT_PID
        working-directory: ./src/backend

      - name: Run unit tests (parallel)
        run: npm run test -- --ci --parallel --maxWorkers=4
        working-directory: ./src/backend
        env:
          CI: true

      - name: Run integration tests
        uses: nick-invision/retry@v2
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: cd src/backend && npm run test:coverage

      - name: Generate coverage report
        run: npm run test:coverage -- --coverageReporters=json-summary --coverageReporters=lcov
        working-directory: ./src/backend
        if: matrix.node-version == '18.x'

      - name: Check coverage threshold
        if: matrix.node-version == '18.x'
        run: |
          COVERAGE=$(jq '.total.lines.pct' coverage/coverage-summary.json)
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < $TEST_COVERAGE_THRESHOLD" | bc -l) )); then
            echo "::error::Test coverage ($COVERAGE%) is below threshold ($TEST_COVERAGE_THRESHOLD%)"
            exit 1
          fi
        working-directory: ./src/backend

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '18.x'
        with:
          name: coverage-report-node-${{ matrix.node-version }}
          path: src/backend/coverage/
          retention-days: 30

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request' && matrix.node-version == '18.x'
        uses: romeovs/lcov-reporter-action@v0.3.1
        with:
          lcov-file: ./src/backend/coverage/lcov.info
          github-token: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run Snyk scan
        uses: snyk/actions/node@v3
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=${{ env.VULNERABILITY_THRESHOLD }}

      - name: Run Trivy scan
        uses: aquasecurity/trivy-action@v1
        with:
          scan-type: 'fs'
          security-checks: 'vuln,config,secret'
          severity: 'CRITICAL,HIGH'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

  docker-build:
    name: Build Docker Images
    needs: [build, security-scan]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [api-gateway, task-service, emr-service, sync-service]
        include:
          - service: api-gateway
            size_limit: 100
          - service: task-service
            size_limit: 200
          - service: emr-service
            size_limit: 300
          - service: sync-service
            size_limit: 50
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        with:
          buildkitd-flags: --debug

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.DOCKER_REGISTRY }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: ./src/backend
          file: ./src/backend/Dockerfile
          target: ${{ matrix.service }}
          push: true
          tags: ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            SERVICE=${{ matrix.service }}
            NODE_VERSION=${{ env.NODE_VERSION }}

      - name: Check image size
        run: |
          SIZE=$(docker image inspect ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ github.sha }} --format='{{.Size}}')
          SIZE_MB=$((SIZE/1024/1024))
          if [ $SIZE_MB -gt ${{ matrix.size_limit }} ]; then
            echo "Image size ($SIZE_MB MB) exceeds limit (${{ matrix.size_limit }} MB)"
            exit 1
          fi

      - name: Sign image
        run: |
          cosign sign --key ${{ secrets.DOCKER_SIGNING_KEY }} \
            ${{ env.DOCKER_REGISTRY }}/${{ matrix.service }}:${{ github.sha }}

  deploy:
    name: Deploy
    needs: [docker-build]
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Deploy to staging
        if: github.ref != 'refs/heads/main'
        run: |
          helm upgrade --install backend ./src/backend/helm \
            --namespace staging \
            --values ./src/backend/helm/values-staging.yaml \
            --set image.tag=${{ github.sha }} \
            --atomic --timeout 5m

      - name: Deploy to production
        if: github.ref == 'refs/heads/main'
        run: |
          # Canary deployment
          helm upgrade --install backend ./src/backend/helm \
            --namespace production \
            --values ./src/backend/helm/values-production.yaml \
            --set image.tag=${{ github.sha }} \
            --set canary.enabled=true \
            --set canary.weight=20 \
            --atomic --timeout 15m

      - name: Run smoke tests
        run: |
          ./scripts/smoke-tests.sh ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}

      - name: Monitor deployment health
        run: |
          ./scripts/monitor-deployment.sh \
            --namespace ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }} \
            --timeout 10m

      - name: Rollback on failure
        if: failure()
        run: |
          helm rollback backend -n ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}