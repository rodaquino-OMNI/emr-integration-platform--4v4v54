name: SBOM Generation & Vulnerability Analysis

on:
  push:
    branches: [main]
    tags: ['v*']
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write
  packages: read
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  SBOM_FORMAT: cyclonedx-json
  GRYPE_DB_AUTO_UPDATE: true

jobs:
  generate-sbom:
    name: Generate Software Bill of Materials
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        component:
          - name: backend
            path: ./src/backend
          - name: web
            path: ./src/web
          - name: mobile-android
            path: ./src/mobile
          - name: mobile-ios
            path: ./src/mobile
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ matrix.component.path }}

      - name: Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate SBOM with Syft (CycloneDX)
        run: |
          syft packages ${{ matrix.component.path }} \
            -o ${{ env.SBOM_FORMAT }} \
            --file sbom-${{ matrix.component.name }}-cyclonedx.json

      - name: Generate SBOM with Syft (SPDX)
        run: |
          syft packages ${{ matrix.component.path }} \
            -o spdx-json \
            --file sbom-${{ matrix.component.name }}-spdx.json

      - name: Generate SBOM metadata
        run: |
          cat > sbom-${{ matrix.component.name }}-metadata.json << EOF
          {
            "component": "${{ matrix.component.name }}",
            "version": "${{ github.ref_name }}",
            "commit": "${{ github.sha }}",
            "generatedAt": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "repository": "${{ github.repository }}",
            "workflow": "${{ github.workflow }}",
            "runId": "${{ github.run_id }}"
          }
          EOF

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ matrix.component.name }}
          path: |
            sbom-${{ matrix.component.name }}-*.json
          retention-days: 90

      - name: Attach SBOM to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            sbom-${{ matrix.component.name }}-cyclonedx.json
            sbom-${{ matrix.component.name }}-spdx.json
            sbom-${{ matrix.component.name }}-metadata.json

  vulnerability-scan:
    name: Vulnerability Scanning with Grype
    needs: generate-sbom
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        component: [backend, web, mobile-android, mobile-ios]
    steps:
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ matrix.component }}

      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan SBOM for vulnerabilities
        run: |
          grype sbom:sbom-${{ matrix.component }}-cyclonedx.json \
            -o json \
            --file grype-results-${{ matrix.component }}.json

      - name: Generate vulnerability summary
        run: |
          grype sbom:sbom-${{ matrix.component }}-cyclonedx.json \
            -o table \
            --file grype-summary-${{ matrix.component }}.txt

      - name: Generate SARIF report
        run: |
          grype sbom:sbom-${{ matrix.component }}-cyclonedx.json \
            -o sarif \
            --file grype-results-${{ matrix.component }}.sarif

      - name: Upload Grype results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: grype-results-${{ matrix.component }}.sarif
          category: grype-${{ matrix.component }}

      - name: Check vulnerability threshold
        run: |
          CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' grype-results-${{ matrix.component }}.json)
          HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' grype-results-${{ matrix.component }}.json)

          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical vulnerabilities in ${{ matrix.component }}"
            exit 1
          fi

          if [ "$HIGH" -gt 5 ]; then
            echo "::warning::Found $HIGH high vulnerabilities in ${{ matrix.component }}"
          fi

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: grype-report-${{ matrix.component }}
          path: |
            grype-results-${{ matrix.component }}.json
            grype-summary-${{ matrix.component }}.txt
            grype-results-${{ matrix.component }}.sarif
          retention-days: 90

  sbom-attestation:
    name: Sign and Attest SBOM
    needs: [generate-sbom, vulnerability-scan]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.ref == 'refs/heads/main'
    permissions:
      contents: write
      id-token: write
      attestations: write
    strategy:
      matrix:
        component: [backend, web, mobile-android, mobile-ios]
    steps:
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ matrix.component }}

      - name: Attest SBOM
        uses: actions/attest-sbom@v1
        with:
          subject-path: sbom-${{ matrix.component }}-cyclonedx.json
          sbom-path: sbom-${{ matrix.component }}-cyclonedx.json

  sbom-upload:
    name: Upload SBOM to Dependency Track
    needs: generate-sbom
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        component: [backend, web, mobile-android, mobile-ios]
    steps:
      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom-${{ matrix.component }}

      - name: Upload to Dependency Track
        if: env.DEPENDENCY_TRACK_URL != ''
        env:
          DEPENDENCY_TRACK_URL: ${{ secrets.DEPENDENCY_TRACK_URL }}
          DEPENDENCY_TRACK_API_KEY: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}
        run: |
          curl -X POST "$DEPENDENCY_TRACK_URL/api/v1/bom" \
            -H "Content-Type: multipart/form-data" \
            -H "X-Api-Key: $DEPENDENCY_TRACK_API_KEY" \
            -F "project=${{ matrix.component }}" \
            -F "autoCreate=true" \
            -F "projectVersion=${{ github.ref_name }}" \
            -F "bom=@sbom-${{ matrix.component }}-cyclonedx.json"

  sbom-report:
    name: Generate SBOM Summary Report
    needs: [generate-sbom, vulnerability-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate comprehensive report
        run: |
          echo "# SBOM Generation & Vulnerability Report" > sbom-report.md
          echo "" >> sbom-report.md
          echo "**Generated:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> sbom-report.md
          echo "**Commit:** ${{ github.sha }}" >> sbom-report.md
          echo "**Ref:** ${{ github.ref }}" >> sbom-report.md
          echo "" >> sbom-report.md

          for component in backend web mobile-android mobile-ios; do
            echo "## Component: $component" >> sbom-report.md

            if [ -f "grype-report-$component/grype-summary-$component.txt" ]; then
              echo "\`\`\`" >> sbom-report.md
              cat "grype-report-$component/grype-summary-$component.txt" >> sbom-report.md
              echo "\`\`\`" >> sbom-report.md
            fi

            echo "" >> sbom-report.md
          done

      - name: Add to job summary
        run: cat sbom-report.md >> $GITHUB_STEP_SUMMARY

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        with:
          name: sbom-consolidated-report
          path: sbom-report.md
          retention-days: 90
